SELECT SMP.*,  
DPP.OLD_AVERAGE_BALANCE_AMNT,  
DPP.OLD_BALANCE_M01_AMNT,  
DPP.OLD_BALANCE_M02_AMNT,  
DPP.OLD_BALANCE_M03_AMNT,  
DPP.OLD_BALANCE_M04_AMNT,  
DPP.OLD_BALANCE_M05_AMNT,  
DPP.OLD_BALANCE_M06_AMNT,  
DPP.OLD_BALANCE_M07_AMNT,  
DPP.OLD_BALANCE_M08_AMNT,  
DPP.OLD_BALANCE_M09_AMNT,  
DPP.OLD_BALANCE_M10_AMNT,  
DPP.OLD_BALANCE_M11_AMNT,  
DPP.OLD_BALANCE_M12_AMNT  
FROM (  
SELECT   
  SIM.CUSTOMER_NUM, SIM.CUSTOMER_NAME_TEXT, SIM.PORTFOLIO_ID, SIM.REGION_NUM, SIM.UNIT_NUM, SIM.LOB_CODE,  
  SIM.CUST_PLAN_TYPE,DETAIL.SIMULATION_STATUS,SIM.PLAN_FLAG,  
DETAIL.DATA_TYPE,  
DETAIL.CP_PRODUCT_ID,  
TOTAL.CP_PRODUCT_NAME_TEXT,  
DETAIL.AVERAGE_BALANCE_AMNT,  
DETAIL.BALANCE_M01_AMNT,  
DETAIL.BALANCE_M02_AMNT,  
DETAIL.BALANCE_M03_AMNT,  
DETAIL.BALANCE_M04_AMNT,  
DETAIL.BALANCE_M05_AMNT,  
DETAIL.BALANCE_M06_AMNT,  
DETAIL.BALANCE_M07_AMNT,  
DETAIL.BALANCE_M08_AMNT,  
DETAIL.BALANCE_M09_AMNT,  
DETAIL.BALANCE_M10_AMNT,  
DETAIL.BALANCE_M11_AMNT,  
DETAIL.BALANCE_M12_AMNT  
  
FROM   
    TGARPYS.T_CP_PRIORITY_CUST_LIST_SIM SIM  left JOIN  (  TGARPYS.T_CP_CUSTOMER_DETAIL DETAIL  INNER JOIN  (  
SELECT   
DEF.CP_PRODUCT_ID,   
DEF.CP_PRODUCT_NAME_TEXT,  
DEF.PLAN_ORDER_NUM    
FROM   
    TGARPYS.T_CP_PRODUCT_DEFINITION DEF    
WHERE  
  (DEF.ETL_DATE =  TO_DATE('31.12.2023','DD.MM.YYYY')  
AND DEF.PLAN_COMMIT_VISIBLE_FLAG IN ('ALL','P') )  
 ) TOTAL  
    ON  TOTAL.CP_PRODUCT_ID = DETAIL.CP_PRODUCT_ID  
     )    
    ON  SIM.CUSTOMER_NUM = DETAIL.CUSTOMER_NUM  
WHERE  
  (SIM.ETL_DATE = TO_DATE('31.12.2023','DD.MM.YYYY')    
AND SIM.SIMULATION_STATUS is not null    
AND SIM.PORTFOLIO_ID = 0029563  
) AND   (DETAIL.ETL_DATE = TO_DATE('31.12.2023','DD.MM.YYYY')   
AND DETAIL.SIMULATION_STATUS is not null  
AND DETAIL.DATA_TYPE IN ('SM')  
) order by TOTAL.PLAN_ORDER_NUM   ) SMP LEFT JOIN  
(SELECT   
  SIM.CUSTOMER_NUM, SIM.CUSTOMER_NAME_TEXT, SIM.PORTFOLIO_ID, SIM.REGION_NUM, SIM.UNIT_NUM, SIM.LOB_CODE,  
  SIM.CUST_PLAN_TYPE,DETAIL.SIMULATION_STATUS,SIM.PLAN_FLAG,  
DETAIL.DATA_TYPE,  
DETAIL.CP_PRODUCT_ID,  
TOTAL.CP_PRODUCT_NAME_TEXT,  
DETAIL.AVERAGE_BALANCE_AMNT OLD_AVERAGE_BALANCE_AMNT,  
DETAIL.BALANCE_M01_AMNT OLD_BALANCE_M01_AMNT,  
DETAIL.BALANCE_M02_AMNT OLD_BALANCE_M02_AMNT,  
DETAIL.BALANCE_M03_AMNT OLD_BALANCE_M03_AMNT,  
DETAIL.BALANCE_M04_AMNT OLD_BALANCE_M04_AMNT,  
DETAIL.BALANCE_M05_AMNT OLD_BALANCE_M05_AMNT,  
DETAIL.BALANCE_M06_AMNT OLD_BALANCE_M06_AMNT,  
DETAIL.BALANCE_M07_AMNT OLD_BALANCE_M07_AMNT,  
DETAIL.BALANCE_M08_AMNT OLD_BALANCE_M08_AMNT,  
DETAIL.BALANCE_M09_AMNT OLD_BALANCE_M09_AMNT,  
DETAIL.BALANCE_M10_AMNT OLD_BALANCE_M10_AMNT,  
DETAIL.BALANCE_M11_AMNT OLD_BALANCE_M11_AMNT,  
DETAIL.BALANCE_M12_AMNT OLD_BALANCE_M12_AMNT  
  
FROM   
    TGARPYS.T_CP_PRIORITY_CUST_LIST_SIM SIM  left JOIN  (  TGARPYS.T_CP_CUSTOMER_DETAIL DETAIL  INNER JOIN  (  
SELECT   
DEF.CP_PRODUCT_ID,   
DEF.CP_PRODUCT_NAME_TEXT,  
DEF.PLAN_ORDER_NUM    
FROM   
    TGARPYS.T_CP_PRODUCT_DEFINITION DEF    
WHERE  
  (DEF.ETL_DATE =  TO_DATE('31.12.2023','DD.MM.YYYY')
AND DEF.PLAN_COMMIT_VISIBLE_FLAG IN ('ALL','P') )   
 ) TOTAL  
    ON  TOTAL.CP_PRODUCT_ID = DETAIL.CP_PRODUCT_ID  
     )    
    ON  SIM.CUSTOMER_NUM = DETAIL.CUSTOMER_NUM  
WHERE  
  (SIM.ETL_DATE = TO_DATE('31.12.2023','DD.MM.YYYY')      
AND SIM.SIMULATION_STATUS is not null    
AND SIM.PORTFOLIO_ID = 0029563  
) AND   (DETAIL.ETL_DATE = TO_DATE('31.12.2023','DD.MM.YYYY')  
AND DETAIL.DATA_TYPE IN ('DP') 
) order by TOTAL.PLAN_ORDER_NUM ) DPP ON SMP.CUSTOMER_NUM=DPP.CUSTOMER_NUM AND SMP.CP_PRODUCT_ID=DPP.CP_PRODUCT_ID ;
